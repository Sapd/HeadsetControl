name: Build

on:
  push:
    branches: [master]
  pull_request:

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    defaults:
      run:
        shell: ${{ matrix.shell || 'bash' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux
            os: ubuntu-latest
            shell: bash
          - name: macOS
            os: macos-latest
            shell: bash
          - name: Windows (MinGW)
            os: windows-latest
            shell: msys2 {0}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Windows: Setup MSYS2
      - name: Setup MSYS2
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: base-devel mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-ninja mingw-w64-x86_64-hidapi

      # Linux/macOS: Setup CMake and Ninja
      - name: Setup CMake and Ninja
        if: runner.os != 'Windows'
        uses: lukka/get-cmake@latest

      # Linux: Install GCC 13 for C++20 support
      - name: Install GCC 13 (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-13 g++-13 libhidapi-dev
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
          sudo update-alternatives --install /usr/bin/cc cc /usr/bin/gcc-13 100
          sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/g++-13 100

      # macOS: Install dependencies
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install hidapi

      # Linux/macOS: Build with CMake Presets
      - name: Build and test (Unix)
        if: runner.os != 'Windows'
        uses: lukka/run-cmake@v10
        with:
          configurePreset: 'default'
          buildPreset: 'default'
          testPreset: 'default'

      # Windows: Build with MSYS2
      - name: Build and test (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir build
          cd build
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Release ..
          ninja
          ctest --output-on-failure
