name: Continuous Build & Release

on:
  workflow_dispatch:
  push:
    branches: [master]
    paths:
      - "cmake_modules/**"
      - "lib/**"
      - "cli/**"
      - "tests/**"
      - "CMakeLists.txt"
      - "CMakePresets.json"
      - "vcpkg.json"
      - ".github/workflows/continuos-release.yml"

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    defaults:
      run:
        shell: ${{ matrix.shell }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows MinGW (MSYS2)
          - os: windows-latest
            os_name: windows-mingw
            architecture: x86_64
            shell: msys2 {0}
            build_type: mingw
          # Windows MSVC (native)
          - os: windows-latest
            os_name: windows-msvc
            architecture: x86_64
            shell: pwsh
            build_type: msvc
          # Linux (Ubuntu 22.04 for glibc 2.35 compatibility)
          - os: ubuntu-22.04
            os_name: linux
            architecture: x86_64
            shell: bash
            build_type: unix
          # macOS (ARM64 - macos-latest uses M1 runners)
          - os: macos-latest
            os_name: macos
            architecture: arm64
            shell: bash
            build_type: unix

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      # =========== Linux Setup ===========
      - name: Install dependencies (Linux)
        if: matrix.os_name == 'linux'
        run: |
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get install -y gcc-13 g++-13 libhidapi-dev rpm ccache
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100

      - name: Cache ccache (Linux)
        if: matrix.os_name == 'linux'
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.cache/ccache
          key: ${{ matrix.os_name }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ matrix.os_name }}-ccache-

      - name: Configure ccache (Linux)
        if: matrix.os_name == 'linux'
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z

      - name: Cache linuxdeploy (Linux)
        if: matrix.os_name == 'linux'
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: /tmp/linuxdeploy
          key: linuxdeploy-x86_64-continuous

      # =========== macOS Setup ===========
      - name: Cache Homebrew
        if: matrix.os_name == 'macos'
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ~/Library/Caches/Homebrew
            /usr/local/Cellar/hidapi
            /opt/homebrew/Cellar/hidapi
          key: ${{ runner.os }}-brew-${{ hashFiles('.github/workflows/continuos-release.yml') }}
          restore-keys: |
            ${{ runner.os }}-brew-

      - name: Install dependencies (macOS)
        if: matrix.os_name == 'macos'
        run: |
          brew install hidapi || true
          brew link hidapi || true

      # =========== Windows MinGW Setup ===========
      - name: Setup MSYS2 (MinGW)
        if: matrix.build_type == 'mingw'
        uses: msys2/setup-msys2@4f806de0a5a7294ffabaff804b38a9b435a73bda # v2.30.0
        with:
          msystem: MINGW64
          update: true
          install: base-devel mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-hidapi make zip

      # =========== Windows MSVC Setup ===========
      - name: Setup vcpkg (MSVC)
        if: matrix.build_type == 'msvc'
        uses: lukka/run-vcpkg@5e0cab206a5ea620130caf672fce3e4a6b5666a1 # v11.5
        with:
          vcpkgGitCommitId: '84bab45d415d22042bd0b9081aea57f362da3f35'  # 2025.12.12
          vcpkgJsonGlob: 'vcpkg.json'

      - name: Setup CMake and Ninja (MSVC)
        if: matrix.build_type == 'msvc'
        uses: lukka/get-cmake@9e07ecdcee1b12e5037e42f410b67f03e2f626e1 # v4.2.1

      - name: Install NSIS (MSVC)
        if: matrix.build_type == 'msvc'
        run: choco install nsis -y

      # =========== Linux/macOS CMake Setup ===========
      - name: Setup CMake and Ninja (Unix)
        if: matrix.build_type == 'unix'
        uses: lukka/get-cmake@9e07ecdcee1b12e5037e42f410b67f03e2f626e1 # v4.2.1

      # =========== Build Steps ===========

      # Windows MinGW Build
      - name: Build and test (Windows MinGW)
        if: matrix.build_type == 'mingw'
        run: |
          mkdir build
          cd build
          cmake -G"MSYS Makefiles" -DCMAKE_BUILD_TYPE=Release ..
          make
          ctest --output-on-failure
          strip headsetcontrol.exe

      # Windows MSVC Build
      - name: Build and test (Windows MSVC)
        if: matrix.build_type == 'msvc'
        uses: lukka/run-cmake@af1be47fd7c933593f687731bc6fdbee024d3ff4 # v10.8
        with:
          configurePreset: 'windows-msvc'
          buildPreset: 'windows-msvc'
          testPreset: 'windows-msvc'

      # Linux/macOS Build
      - name: Build and test (Unix)
        if: matrix.build_type == 'unix'
        uses: lukka/run-cmake@af1be47fd7c933593f687731bc6fdbee024d3ff4 # v10.8
        with:
          configurePreset: 'default'
          buildPreset: 'default'
          testPreset: 'default'
        env:
          CMAKE_C_COMPILER_LAUNCHER: ${{ matrix.os_name == 'linux' && 'ccache' || '' }}
          CMAKE_CXX_COMPILER_LAUNCHER: ${{ matrix.os_name == 'linux' && 'ccache' || '' }}

      - name: Show ccache stats (Linux)
        if: matrix.os_name == 'linux'
        run: ccache -s

      # =========== Post-Build ===========

      # Strip binaries (Unix only - Windows MinGW already stripped, MSVC doesn't use strip)
      - name: Strip binaries (Unix)
        if: matrix.build_type == 'unix'
        run: strip build/headsetcontrol

      # Generate Linux packages (.deb, .rpm, AppImage)
      - name: Generate Linux packages
        if: matrix.os_name == 'linux'
        run: |
          cd build

          # Generate .deb package
          cpack -G DEB

          # Generate .rpm package
          cpack -G RPM

          # Generate checksums for .deb and .rpm
          for pkg in *.deb *.rpm; do
            sha256sum "$pkg" > "$pkg.sha256"
          done

      - name: Generate AppImage (Linux)
        if: matrix.os_name == 'linux'
        run: |
          cd build

          # Use cached linuxdeploy or download if not cached
          if [ -f /tmp/linuxdeploy/linuxdeploy-x86_64.AppImage ]; then
            cp /tmp/linuxdeploy/linuxdeploy-x86_64.AppImage .
          else
            wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
            mkdir -p /tmp/linuxdeploy
            cp linuxdeploy-x86_64.AppImage /tmp/linuxdeploy/
          fi
          chmod +x linuxdeploy-x86_64.AppImage

          # Minimal .desktop file (required, but hidden from app menus with NoDisplay=true)
          printf '%s\n' '[Desktop Entry]' 'Type=Application' 'Name=HeadsetControl' 'Exec=headsetcontrol' 'Icon=headsetcontrol' 'Categories=Utility;' 'Terminal=true' 'NoDisplay=true' > headsetcontrol.desktop

          # Copy icon from assets
          cp ../assets/headsetcontrol.png headsetcontrol.png

          # Build AppImage - linuxdeploy automatically bundles libhidapi and other dependencies
          # Use --appimage-extract-and-run to avoid FUSE issues on GitHub Actions runners
          # DEPLOY_LIBSTDCPP=1 bundles libstdc++ for compatibility with older systems
          DEPLOY_LIBSTDCPP=1 ./linuxdeploy-x86_64.AppImage --appimage-extract-and-run \
            --appdir AppDir \
            --executable headsetcontrol \
            --desktop-file headsetcontrol.desktop \
            --icon-file headsetcontrol.png \
            --output appimage

          # Rename to standard format
          mv HeadsetControl-*.AppImage headsetcontrol-${{ matrix.architecture }}.AppImage

          # Generate checksum
          sha256sum headsetcontrol-${{ matrix.architecture }}.AppImage > headsetcontrol-${{ matrix.architecture }}.AppImage.sha256

      # Package artifacts
      - name: Package artifacts (MinGW)
        if: matrix.build_type == 'mingw'
        run: |
          cd build
          zip -9 headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip headsetcontrol.exe
          sha256sum headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip > headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip.sha256

      - name: Generate Windows installer (MSVC)
        if: matrix.build_type == 'msvc'
        run: |
          cd build-msvc
          cpack -G NSIS
          # Find and rename the installer (matches headsetcontrol-*.exe but not plain headsetcontrol.exe)
          $installer = Get-ChildItem -Filter "headsetcontrol-*.exe" | Select-Object -First 1
          if ($installer) {
            $newName = "headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}-setup.exe"
            Rename-Item -Path $installer.FullName -NewName $newName
            $hash = (Get-FileHash -Algorithm SHA256 $newName).Hash.ToLower()
            [System.IO.File]::WriteAllText("$newName.sha256", "$hash  $newName`n")
          }

      - name: Package artifacts (Unix)
        if: matrix.build_type == 'unix'
        run: |
          cd build
          zip -9 headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip headsetcontrol
          if [ "${{ matrix.os_name }}" = "macos" ]; then
            shasum -a 256 headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip > headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip.sha256
          else
            sha256sum headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip > headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip.sha256
          fi

      - name: Upload build artifacts (MinGW)
        if: matrix.build_type == 'mingw'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}
          path: |
            build/headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip
            build/headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip.sha256
          retention-days: 90

      - name: Upload build artifacts (Linux)
        if: matrix.os_name == 'linux'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}
          path: |
            build/headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip
            build/headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip.sha256
            build/*.deb
            build/*.deb.sha256
            build/*.rpm
            build/*.rpm.sha256
            build/headsetcontrol-*.AppImage
            build/headsetcontrol-*.AppImage.sha256
          retention-days: 90

      - name: Upload build artifacts (macOS)
        if: matrix.os_name == 'macos'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}
          path: |
            build/headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip
            build/headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}.zip.sha256
          retention-days: 90

      - name: Upload build artifacts (MSVC)
        if: matrix.build_type == 'msvc'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: headsetcontrol-${{ matrix.os_name }}-${{ matrix.architecture }}-installer
          path: |
            build-msvc/headsetcontrol-*-setup.exe
            build-msvc/headsetcontrol-*-setup.exe.sha256
          retention-days: 90

  create-release:
    needs: [build]
    if: github.ref == 'refs/heads/master'  # Only create release from master
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          merge-multiple: true
          path: ./artifacts

      - name: Generate changelog
        id: changelog
        run: |
          echo "## ðŸš€ Continuous Build" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "Latest automated build from \`master\` branch." >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ðŸ“¦ Downloads" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "#### Windows" >> CHANGELOG.md
          for file in artifacts/*-setup.exe; do
            if [ -f "$file" ]; then
              name=$(basename "$file")
              echo "- [${name}](https://github.com/${{ github.repository }}/releases/download/continuous/${name}) (Installer - recommended)" >> CHANGELOG.md
            fi
          done
          for file in artifacts/*windows-mingw*.zip; do
            if [ -f "$file" ]; then
              name=$(basename "$file")
              echo "- [${name}](https://github.com/${{ github.repository }}/releases/download/continuous/${name}) (Portable)" >> CHANGELOG.md
            fi
          done
          echo "" >> CHANGELOG.md
          echo "#### Linux" >> CHANGELOG.md
          for file in artifacts/headsetcontrol-*.AppImage; do
            if [ -f "$file" ]; then
              echo "- [$(basename "$file")](https://github.com/${{ github.repository }}/releases/download/continuous/$(basename "$file")) (AppImage - universal)" >> CHANGELOG.md
            fi
          done
          for file in artifacts/*.deb; do
            if [ -f "$file" ]; then
              echo "- [$(basename "$file")](https://github.com/${{ github.repository }}/releases/download/continuous/$(basename "$file")) (Debian/Ubuntu)" >> CHANGELOG.md
            fi
          done
          for file in artifacts/*.rpm; do
            if [ -f "$file" ]; then
              echo "- [$(basename "$file")](https://github.com/${{ github.repository }}/releases/download/continuous/$(basename "$file")) (Fedora/RHEL)" >> CHANGELOG.md
            fi
          done
          for file in artifacts/*linux*.zip; do
            if [ -f "$file" ]; then
              echo "- [$(basename "$file")](https://github.com/${{ github.repository }}/releases/download/continuous/$(basename "$file")) (portable binary)" >> CHANGELOG.md
            fi
          done
          echo "" >> CHANGELOG.md
          echo "#### macOS" >> CHANGELOG.md
          for file in artifacts/*macos*.zip; do
            if [ -f "$file" ]; then
              echo "- [$(basename "$file")](https://github.com/${{ github.repository }}/releases/download/continuous/$(basename "$file"))" >> CHANGELOG.md
            fi
          done
          echo "" >> CHANGELOG.md
          echo "### ðŸ” Checksums (SHA256)" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          cat artifacts/*.sha256 >> CHANGELOG.md 2>/dev/null || true
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ðŸ“ Recent Changes" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          git log --oneline -10 >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "---" >> CHANGELOG.md
          echo "*Built from commit: \`${{ github.sha }}\`*" >> CHANGELOG.md

      - name: Create/Update continuous release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          tag: continuous
          name: 'Continuous Build'
          bodyFile: CHANGELOG.md
          artifacts: "artifacts/*"
          allowUpdates: true
          removeArtifacts: true
          prerelease: true
          makeLatest: false
          token: ${{ secrets.GITHUB_TOKEN }}
